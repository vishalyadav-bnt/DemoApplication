name: SonarQube SAST Workflow with TestContainers

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sonarqube-scan:
    name: Run SonarQube Analysis with TestContainers
    runs-on: ubuntu-latest
    permissions: 
      contents: read
      packages: write
      security-events: write 
      actions: write
      id-token: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Java 21
        uses: actions/setup-java@v3
        with:
          java-version: 21
          distribution: 'adopt'
          cache: gradle

      - name: Make Gradle Wrapper Executable
        run: chmod +x Demo/gradlew
        
      - name: Start SonarQube Container
        run: |
          docker run -d --name sonarqube -p 9000:9000 sonarqube:lts
          echo "Waiting for SonarQube to start..."
          timeout 300 bash -c 'while [[ "$(curl -s -o /dev/null -w ''%{http_code}'' localhost:9000/api/system/status)" != "200" ]]; do sleep 5; done' || false
          echo "SonarQube is ready"

      - name: Change Default SonarQube Password
        run: |
          sleep 30
          curl -X POST -u admin:admin "http://localhost:9000/api/users/change_password?login=admin&previousPassword=admin&password=admin123"

      - name: Build and Test
        run: |
          cd Demo && ./gradlew clean build test --info

      # Create output directory for SARIF
      - name: Create SARIF output directory
        run: mkdir -p Demo/build/sonar/scanner-report/

      - name: Run SonarQube Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          cd Demo && ./gradlew sonarqube \
            -Dsonar.host.url=http://localhost:9000 \
            -Dsonar.login=admin \
            -Dsonar.password=admin123 \
            -Dsonar.verbose=true \
            -Dsonar.analysis.mode=publish \
            -Dsonar.projectKey=testcontainer-project \
            -Dsonar.java.binaries=build/classes/java/main \
            -Dsonar.java.test.binaries=build/classes/java/test \
            -Dsonar.sources=src/main/java \
            -Dsonar.tests=src/test/java \
            -Dsonar.java.libraries=build/libs/*.jar \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.working.directory=build/sonar \
            -Dsonar.sarif.path=build/sonar/scanner-report/sonar-report.sarif \
            --info

      # Wait for analysis to complete and convert report to SARIF
      - name: Convert SonarQube report to SARIF
        run: |
          cd Demo
          # Wait for the analysis to complete
          sleep 30
          
          # Create a basic SARIF structure if it doesn't exist
          if [ ! -f "build/sonar/scanner-report/sonar-report.sarif" ]; then
            echo '{
              "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
              "version": "2.1.0",
              "runs": [{
                "tool": {
                  "driver": {
                    "name": "SonarQube",
                    "rules": []
                  }
                },
                "results": []
              }]
            }' > build/sonar/scanner-report/sonar-report.sarif
          fi

      - name: Copy SARIF to artifact location
        run: |
          mkdir -p sonar-reports
          # Copy all report files for debugging
          cp -r Demo/build/sonar/scanner-report/* sonar-reports/ || true
          
          # Create empty SARIF if missing
          if [ ! -f "sonar-reports/sonar-report.sarif" ]; then
            echo '{
              "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
              "version": "2.1.0",
              "runs": []
            }' > sonar-reports/sonar-report.sarif
          fi

      - name: Debug Report Contents
        run: |
          echo "Contents of scanner-report directory:"
          ls -la Demo/build/sonar/scanner-report/
          echo "Contents of sonar-reports directory:"
          ls -la sonar-reports/

      - name: Upload SARIF File as Artifact
        uses: actions/upload-artifact@v3
        with:
          name: sonar-report
          path: sonar-reports/
          retention-days: 30

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: Demo/build/reports/tests/
          retention-days: 7